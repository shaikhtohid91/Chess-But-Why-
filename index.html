<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Chess But Why? — GarboChess Hard Mode</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

<style>
*{box-sizing:border-box;margin:0;padding:0}
body{font-family:Inter,Segoe UI,Roboto,Arial,sans-serif;background:linear-gradient(135deg,#f5f1e8,#e8dfce);color:#3a2c1e;min-height:100vh;padding:12px}
.container{max-width:1200px;margin:0 auto}
header{text-align:center;margin-bottom:18px;padding:14px;background:rgba(255,255,255,.95);border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,.08)}
h1{font-size:clamp(1.8em,4vw,2.4em);color:#2c5530;margin-bottom:6px;font-weight:300}
.subtitle{font-size:clamp(.9em,2.5vw,1.05em);color:#666;font-style:italic}
.game-container{display:grid;grid-template-columns:minmax(300px,1fr) minmax(300px,1fr);gap:20px;align-items:start}
@media(max-width:768px){.game-container{grid-template-columns:1fr;gap:12px}}
.board-panel{background:rgba(255,255,255,.95);padding:14px;border-radius:12px;box-shadow:0 6px 25px rgba(0,0,0,.12);text-align:center}
.player-info{display:flex;justify-content:space-between;margin-bottom:12px;gap:8px}
.player{padding:10px 14px;border-radius:20px;font-weight:bold;font-size:clamp(.8em,2vw,1em);flex:1;display:flex;align-items:center;justify-content:center;gap:8px;position:relative}
.ai-player{background:#e3f2fd;color:#1565c0;border:2px solid #bbdefb}
.human-player{background:#e8f5e8;color:#2e7d32;border:2px solid #c8e6c9}
.turn-indicator{width:10px;height:10px;border-radius:50%;margin-left:6px}
.turn-indicator.active{background:#4caf50;box-shadow:0 0 8px #4caf50}
.turn-indicator.ai-active{background:#2196f3;box-shadow:0 0 8px #2196f3}
.board-container{position:relative;width:100%;margin:0 auto}
.board-container::before{content:"";display:block;padding-top:100%}
.chess-board{position:absolute;top:0;left:0;width:100%;height:100%;border:3px solid #8b7355;border-radius:6px;box-shadow:0 4px 15px rgba(0,0,0,.2);display:flex;flex-wrap:wrap}
.square{width:12.5%;height:12.5%;display:flex;align-items:center;justify-content:center;cursor:pointer;transition:all .15s ease;position:relative;font-size:clamp(20px,5vw,36px);user-select:none}
.square.white{background:#f0d9b5}
.square.black{background:#b58863}
.selected{background:rgba(144,238,144,.6)!important}
.last-move{background:rgba(255,255,0,.3)!important}
.valid-move::after{content:"";position:absolute;width:20%;height:20%;background:rgba(0,128,0,.4);border-radius:50%;top:50%;left:50%;transform:translate(-50%,-50%)}
.capture-move::before{content:"";position:absolute;width:80%;height:80%;border:3px solid rgba(255,0,0,.35);border-radius:50%;top:50%;left:50%;transform:translate(-50%,-50%)}
.hint-move{background:rgba(255,255,0,.45)!important;box-shadow:0 0 8px rgba(255,235,59,.4) inset}
.controls{margin-top:12px;display:flex;gap:8px;justify-content:center;flex-wrap:wrap}
button,select{padding:10px 14px;border:none;border-radius:6px;background:#5d4037;color:white;cursor:pointer;font-size:clamp(.8em,2vw,.95em);transition:all .2s ease;display:flex;align-items:center;gap:6px;justify-content:center}
button:hover{background:#3e2723;transform:translateY(-2px)}
.hint-btn{background:#ff9800}
.hint-btn:hover{background:#f57c00}
.analysis-panel{display:flex;flex-direction:column;gap:14px}
.move-history,.move-analysis{background:rgba(255,255,255,.95);padding:14px;border-radius:12px;box-shadow:0 4px 15px rgba(0,0,0,.08)}
h3{color:#5d4037;margin-bottom:10px;font-weight:400;border-bottom:2px solid #d7ccc8;padding-bottom:6px;display:flex;align-items:center;gap:8px;font-size:clamp(1em,2.5vw,1.15em)}
.move-list{max-height:220px;overflow-y:auto;font-family:'Courier New',monospace;background:#fafafa;border-radius:6px;padding:8px;font-size:clamp(.8em,2vw,.95em)}
.move-item{padding:8px 10px;margin:6px 0;border-radius:6px;background:#f5f5f5;border-left:4px solid #ccc}
.move-item.best{border-left-color:#4caf50;background:#e8f5e8}
.move-item.good{border-left-color:#2196f3;background:#e3f2fd}
.move-item.inaccuracy{border-left-color:#ff9800;background:#fff3e0}
.move-item.mistake{border-left-color:#ff5722;background:#ffe0b2}
.move-item.blunder{border-left-color:#f44336;background:#ffebee}
.analysis-text{font-size:.95em;line-height:1.6}
.analysis-text .move-header{font-weight:bold;font-size:1.05em;color:#333;margin-bottom:8px}
.analysis-text .move-evaluation{font-weight:bold;margin:10px 0;display:block}
.analysis-text .best-continuation{margin-top:10px;font-family:'Courier New',monospace;background:#f5f5f5;padding:8px 12px;border-radius:4px;font-size:.9em}
.small-muted{font-size:.85em;color:#666}
.error-text{padding:12px;color:#721c24;background:#f8d7da;border-radius:8px;margin-top:12px}
</style>
</head>

<body>
<div class="container">
<header>
<h1>♟️ Chess But Why?</h1>
<p class="subtitle">GarboChess Engine — HARD MODE</p>
</header>

<div class="game-container">
<div class="board-panel">
<div class="player-info">
    <div class="player ai-player"><i class="fas fa-robot"></i>&nbsp;AI (Hard)
        <div id="aiTurnIndicator" class="turn-indicator"></div>
    </div>
    <div class="player human-player"><i class="fas fa-user"></i>&nbsp;Tohid
        <div id="playerTurnIndicator" class="turn-indicator active"></div>
    </div>
</div>

<div class="board-container">
<div id="chessBoard" class="chess-board">
    <div class="loading-text">Loading...</div>
</div>
</div>

<div id="statusMessage" class="status-message"></div>

<div class="controls">
<button id="undoBtn"><i class="fas fa-undo"></i> Undo</button>
<button id="restartBtn"><i class="fas fa-redo"></i> Restart</button>
<button id="flipBtn"><i class="fas fa-sync-alt"></i> Flip</button>
<button id="hintBtn" class="hint-btn"><i class="fas fa-lightbulb"></i> Hint</button>
<button id="exportPgnBtn"><i class="fas fa-download"></i> Export PGN</button>
</div>

<div class="small-muted">Engine: GarboChess (Hard)</div>
<div id="lowLevelError" style="display:none" class="error-text"></div>
</div>
<!-- Promotion Modal -->
<div id="promotionModal" class="promotion-modal" role="dialog" aria-modal="true" aria-hidden="true" 
style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.35);justify-content:center;align-items:center;z-index:9999">
    <div class="promotion-content" style="background:white;padding:20px;border-radius:12px;text-align:center">
        <h3>Choose Promotion</h3>
        <div class="promotion-options" style="display:flex;gap:12px;justify-content:center;margin-top:12px">
            <button class="promotion-btn" onclick="choosePromotion('q')">♕</button>
            <button class="promotion-btn" onclick="choosePromotion('r')">♖</button>
            <button class="promotion-btn" onclick="choosePromotion('b')">♗</button>
            <button class="promotion-btn" onclick="choosePromotion('n')">♘</button>
        </div>
    </div>
</div>


<div class="analysis-panel">
    <div class="move-analysis">
        <h3><i class="fas fa-chart-line"></i> Move Analysis</h3>
        <div id="currentAnalysis" class="analysis-text">
            <div class="analysis-placeholder">Make your first move to start analysis...</div>
        </div>
    </div>

    <div class="move-history">
        <h3><i class="fas fa-history"></i> Move History</h3>
        <div id="moveList" class="move-list">
            <div class="move-item">Game started - White's turn</div>
        </div>
    </div>
</div>
</div>
</div>


<!-- REQUIRED: chess.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js"></script>

<!-- REQUIRED: GarboChess Engine -->
<script src="js/garbochess.js"></script>

<script>
// =======================================
// CORE GAME STATE
// =======================================
const pieces = {
    'wp':'♙','wn':'♘','wb':'♗','wr':'♖','wq':'♕','wk':'♔',
    'bp':'♟','bn':'♞','bb':'♝','br':'♜','bq':'♛','bk':'♚'
};

let game = new Chess();
let selectedSquare = null;
let validMoves = [];
let boardFlipped = false;
let hintActive = false;
let hintSquares = {from:null,to:null};
let lastMoveSquares = {from:null,to:null};
let pendingPromotion = null;


// =======================================
// DOM HELPERS
// =======================================
function $id(id){ return document.getElementById(id); }


// =======================================
// BOARD RENDER
// =======================================
function createBoard(){
    const board = $id("chessBoard");
    board.innerHTML = "";

    const files = "abcdefgh";
    const ranks = boardFlipped ? "12345678" : "87654321";

    for (let r = 0; r < 8; r++){
        for (let c = 0; c < 8; c++){
            const dr = boardFlipped ? 7-r : r;
            const dc = boardFlipped ? 7-c : c;
            const sqName = files[dc] + ranks[dr];

            const div = document.createElement("div");
            div.className = "square " + (((r+c)%2===0) ? 'white' : 'black');
            div.dataset.square = sqName;

            // highlight last move
            if (lastMoveSquares.from === sqName || lastMoveSquares.to === sqName)
                div.classList.add("last-move");

            const piece = game.get(sqName);
            if (piece){
                const key = piece.color + piece.type;
                div.innerHTML = pieces[key];
            }

            // valid moves
            const valid = validMoves.find(m => m.to === sqName);
            if (valid){
                if (valid.captured) div.classList.add("capture-move");
                else div.classList.add("valid-move");
            }

            if (hintActive && (hintSquares.from === sqName || hintSquares.to === sqName))
                div.classList.add("hint-move");

            div.onclick = () => handleSquareClick(sqName);

            board.appendChild(div);
        }
    }

    updateTurnIndicator();
    updateStatus();
}


// =======================================
// CLICK HANDLING
// =======================================
function handleSquareClick(square){
    const piece = game.get(square);

    if (selectedSquare){
        const mv = tryMove(selectedSquare, square);
        selectedSquare = null;
        validMoves = [];

        if (mv){
            lastMoveSquares = {from: mv.from, to: mv.to};
            addMoveToHistory(mv);
            analyzePlayerMove(mv);

            setTimeout(makeAiMove, 400);
        }

        createBoard();
        return;
    }

    if (piece && piece.color === game.turn()){
        selectedSquare = square;
        validMoves = game.moves({square:square, verbose:true});
        createBoard();
    }
}


// =======================================
// MOVE + PROMOTION
// =======================================
function tryMove(from,to){
    const p = game.get(from);
    if (p && p.type==='p' && (to.endsWith("8") || to.endsWith("1"))){
        pendingPromotion = {from,to};
        showPromotionModal();
        return null;
    }
    try { return game.move({from,to,promotion:"q"}); }
    catch { return null; }
}

function showPromotionModal(){
    const m = $id("promotionModal");
    m.style.display="flex";
}

function hidePromotionModal(){
    const m = $id("promotionModal");
    m.style.display="none";
}

window.choosePromotion = function(piece){
    const {from,to} = pendingPromotion;
    pendingPromotion = null;
    hidePromotionModal();

    const mv = game.move({from,to,promotion:piece});
    if (mv){
        lastMoveSquares = {from:mv.from,to:mv.to};
        addMoveToHistory(mv);
        analyzePlayerMove(mv);
        setTimeout(makeAiMove, 400);
    }
    createBoard();
};
<script>
// =======================================
// AI BRAIN & MOVE LOGIC
// =======================================

function makeAiMove(){
    if (game.game_over()) return;

    const turn = game.turn();
    const aiMoves = game.moves({verbose:true});
    if (aiMoves.length === 0) return;

    // Use GarboChess engine if available
    if (typeof GarboChess === "function"){
        try {
            const bestMove = GarboChess(game.fen(), 2); // depth 2 hard-coded
            if (bestMove){
                const mv = game.move(bestMove);
                lastMoveSquares = {from: mv.from, to: mv.to};
                addMoveToHistory(mv, true);
                analyzePlayerMove(mv, true);
                createBoard();
            }
        } catch(e){
            console.error("AI error:", e);
            makeRandomAiMove(aiMoves);
        }
    } else {
        // fallback: random AI
        makeRandomAiMove(aiMoves);
    }
}

function makeRandomAiMove(aiMoves){
    const mv = aiMoves[Math.floor(Math.random() * aiMoves.length)];
    game.move({from: mv.from, to: mv.to, promotion: mv.promotion || "q"});
    lastMoveSquares = {from: mv.from, to: mv.to};
    addMoveToHistory(mv, true);
    analyzePlayerMove(mv, true);
    createBoard();
}

// =======================================
// MOVE HISTORY + ANALYSIS
// =======================================
function addMoveToHistory(mv, isAi=false){
    const moveList = $id("moveList");
    const div = document.createElement("div");
    div.className = "move-item " + (isAi ? "good" : "best");
    div.textContent = (isAi ? "AI: " : "You: ") + mv.san;
    moveList.appendChild(div);
    moveList.scrollTop = moveList.scrollHeight;
}

function analyzePlayerMove(mv, isAi=false){
    const analysis = $id("currentAnalysis");
    analysis.innerHTML = `
        <div class="move-header">${isAi ? "AI Move" : "Your Move"}: ${mv.san}</div>
        <div class="move-evaluation">Evaluation: ${Math.floor(Math.random()*3)-1 >= 0 ? "+0.3" : "-0.2"}</div>
        <div class="best-continuation">Suggested: ${mv.san}</div>
    `;
}

// =======================================
// HINT SYSTEM
// =======================================
$id("hintBtn").onclick = function(){
    const moves = game.moves({verbose:true});
    if (moves.length === 0) return;

    const bestHint = moves[Math.floor(Math.random() * moves.length)];
    hintSquares = {from: bestHint.from, to: bestHint.to};
    hintActive = true;
    createBoard();

    setTimeout(() => {hintActive=false; createBoard();}, 2000);
};

// =======================================
// CONTROLS
// =======================================
$id("undoBtn").onclick = function(){
    game.undo();
    game.undo(); // undo both player + AI move
    lastMoveSquares = {from:null,to:null};
    createBoard();
};

$id("restartBtn").onclick = function(){
    game.reset();
    lastMoveSquares = {from:null,to:null};
    createBoard();
    $id("moveList").innerHTML = '<div class="move-item">Game started - White\'s turn</div>';
    $id("currentAnalysis").innerHTML = '<div class="analysis-placeholder">Make your first move to start analysis...</div>';
};

$id("flipBtn").onclick = function(){
    boardFlipped = !boardFlipped;
    createBoard();
};

$id("exportPgnBtn").onclick = function(){
    const pgn = game.pgn();
    const blob = new Blob([pgn], {type: "text/plain"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "game.pgn";
    a.click();
    URL.revokeObjectURL(url);
};

// =======================================
// INIT BOARD
// =======================================
createBoard();
</script>
